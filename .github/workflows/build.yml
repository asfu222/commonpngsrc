name: Update commonpng 

on:
  push:
  workflow_dispatch:
  repository_dispatch:
    types: [update-assets]
jobs:
  prepare:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure Submodules to Track Branches
        run: |
          git submodule foreach '
            git checkout main || git checkout -b main
            git branch --set-upstream-to=origin/main main
          '
      - name: Configure Git Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      - name: Update Submodule References
        run: |
          submodule_paths=$(git submodule status | awk '{ print $2 }')
          for submodule in $submodule_paths; do
            git add $submodule
          done
          if git diff --cached --quiet; then
            echo "子模块已是最新状态"
          else
            git commit -m "更新子模块指针 [skip ci]"
            git push --recurse-submodules=on-demand origin HEAD
          fi
          
      - name: Download ba.env
        run: curl -sL -o ba.env https://raw.githubusercontent.com/asfu222/BACNLocalizationResources/refs/heads/main/ba.env

      - name: Cache AssetBundles
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            AssetBundles/
          key: ${{ runner.os }}-baenv-${{ hashFiles('ba.env') }}
      
      - name: Update AssetBundles if needed
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          chmod +x ./baad
          ./baad download japan --android-assets --ios-assets --output AssetBundles
          for dir in AndroidAssetBundles iOSAssetBundles; do
            for zip in AssetBundles/$dir/*.zip; do
              unzip -o "$zip" -d "AssetBundles/$dir"
              rm -f "$zip"
            done
          done

      - name: Prune unnecessary files
        run: |
          find AssetBundles -type f ! -name "*textures*.bundle" ! -name "*mx-addressableassets-uis*.bundle" -delete
          find AssetBundles -type f -name "*mx-spine*.bundle" -delete
          find AssetBundles -type f -name "*mx-npcs*.bundle" -delete
          find AssetBundles -type f -name "*mx-obstacles*.bundle" -delete
          find AssetBundles -type f -name "*mx-cafe*.bundle" -delete
          find AssetBundles -type f -name "*mx-characters*.bundle" -delete

      - name: Save cache
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            AssetBundles/
          key: ${{ runner.os }}-baenv-${{ hashFiles('ba.env') }}

      - name: Split into subfolders
        run: python3 split_into_subfolders.py
        
      - name: Upload chunk 0
        uses: actions/upload-artifact@v4
        with:
          name: bundle-0
          path: |
            AssetBundles/AndroidAssetBundles/0
            AssetBundles/iOSAssetBundles/0

      - name: Upload chunk 1
        uses: actions/upload-artifact@v4
        with:
          name: bundle-1
          path: |
            AssetBundles/AndroidAssetBundles/1
            AssetBundles/iOSAssetBundles/1

      - name: Upload chunk 2
        uses: actions/upload-artifact@v4
        with:
          name: bundle-2
          path: |
            AssetBundles/AndroidAssetBundles/2
            AssetBundles/iOSAssetBundles/2
      - name: Upload chunk 3
        uses: actions/upload-artifact@v4
        with:
          name: bundle-3
          path: |
            AssetBundles/AndroidAssetBundles/3
            AssetBundles/iOSAssetBundles/3
  mod:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chunk: [0,1,2,3]
    steps: 
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.ASSET_REPO_TOKEN }}

      - name: Download chunk
        uses: actions/download-artifact@v4
        with:
          name: bundle-${{ matrix.chunk }}
          path: |
            AssetBundles/AndroidAssetBundles/${{ matrix.chunk }}
            AssetBundles/iOSAssetBundles/${{ matrix.chunk }}

      - name: Mod
        run: |
          pip install -r requirements.txt
          python main.py
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mod-${{ matrix.chunk }}
          path: commonpng

  merge:
    needs: mod
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Clone Target
        env:
          TARGET_REPO_URL: https://x-access-token:${{ secrets.COMMON_PNG_REPO }}@github.com/asfu222/commonpng.git
        run: |
          pip install -r requirements.txt
          git clone --depth 1 --filter=tree:0 --no-checkout "$TARGET_REPO_URL" commonpng

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: mod-*
          path: commonpng

      - name: Setup git identity
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Finish up
        run: |
          python lfs.py split commonpng/Android_PatchPack
          python lfs.py split commonpng/iOS_PatchPack
          cd commonpng
          git add .
          if git diff --cached --quiet; then
            echo "贴图已是最新状态"
          else
            git commit -m "更新贴图包"
            git push origin
          fi
